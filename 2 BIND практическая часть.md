---
создал заметку: "2025-03-09"
---
Установка: 
`sudo apt install bind9`

инструменты мониторинга сети:
`sudo apt install dnsutils`

Запускаем сервис:
`sudo service bind9 start`

Имена всех компьютеров вместе с их адресами можно записать в файл **/etc/hosts.** Порядок просмотра различных пространств имён указывается в файле **/etc/nsswitch.conf**. Строка **hosts: files nisplus nis dns** этого файла предписывает приложениям, пользующимся стандартной функцией *gethostbyname()* сначала заглянуть в /etc/hosts, затем попытаться получить таблицы hosts службы nisplus или nis, а только затем обращаться к **DNS-серверу**.

**Первая задача** — уменьшение времени ответа на DNS-запрос абонентов внутренней сети. **Система доменных имён** — распределённая база данных, замечательно поддерживающая механизм _кеширования_ запросов. Первое обращение к кеширующему DNS-серверу приводит к выполнению _рекурсивного запроса_: опрашивается сервер более высокого уровня, который, если не знает ответа, передаст запрос дальше. Результат запроса оседает в кеше, так что все последующие обращения именно к этой записи дальше кеширующего сервера не уйдут. _Время жизни_ (Time To Live, TTL) записи в кеше определяется хозяином запрошенного доменного имени. По истечении TTL запись из кеша удаляется.

Такой кеш можно организовать в своей сети с помощью демона **pdnsd**. pdnsd — только кеширующий демон, он не работает с _собственными_ таблицами (кеш, однако, сохраняется на диске для последующего использования) и не поддерживает передачу зон.

Перед запуском **service pdnsd start** стоит отредактировать файл /etc/pdnsd.conf, изменив в нём адреса вышестоящих серверов на провайдерские. В /etc/reader.conf первым сервером имён должен быть localhost:

```sh
# cat /etc/resolv.conf
domain internal.domain.net
nameserver 127.0.0.1
```

**Вторая задача** — именование компьютеров в интранет-сети. Это бывает важно, если среди компьютеров внутренней сети есть свои серверы (например, корпоративный WWW-сервер), к которым другие компьютеры обращаются по доменному имени. Поскольку адреса такой сети не пойдут дальше межсетевого экрана, вы можете использовать имя какого угодно, в том числе — несуществующего — домена и составить табличку в /etc/hosts.

**Обе** эти **задачи** можно было решить и воспользовавшись **Bind** — мощным полнофункциональным **DNS-сервером** (обратите внимание, пакет и сервис называются **bind**, а сам демон — **named**). Bind — программа весьма сложная (общий объём документации в пакете bind-doc — более полутора мегабайтов

Для того, чтобы запустить **named** в **кеширующем режиме**, достаточно раскомментировать и заполнить раздел настройки forwarders (вышестоящие серверы) в файле /var/lib/bind/etc/options.conf. Обратите внимание на возможные _ограничения_ на право обращаться к серверу с обычными и рекурсивными запросами (настройки allow-query и allow-recursion). Можно раскомментировать находящиеся в этом файле разумные установки по умолчанию. Эти настройки открывают доступ только абонентам локальных сетей, т. е. сетей, к которым компьютер подключён непосредственно.

```conf
grep allow- /var/lib/bind/etc/options.conf
         //      allow-query { localnets; };
         //      allow-recursion { localnets; };
```


## **Первичный DNS-сервер**

**Первичный DNS-сервер** — сервер, который хранит главную копию файла данных зоны. Все **зоны** будем хранить в каталоге **/etc/bind/master-zones** основного DNS-сервера. Создадим директорию:

```sh
sudo mkdir /etc/bind/master-zones
```

В ней создадим файл для описания зоны:
```sh
sudo touch /etc/bind/master-zones/test.example.com.loсal.zone
```


и добавим в него SOA-, NS- и A-записи:

```sh
$ttl 3600 
$ORIGIN test.example.com. 
test.example.com.               IN              SOA  (      
ns.test.example.com.    
abuse.test.example.com.  
                                2022041201 
                                10800 
                                1200 
                                604800 
                                3600   ) 

@                               IN              NS              ns.test.example.com. 
@                               IN              NS              ns2.test.example.com.

@                               IN              A                172.16.101.3 
ns                              IN               A                172.16.0.5 
ns2                             IN              A                172.16.0.6
```

После этого необходимо запустить проверку утилитой **named-checkzone**.

```
sudo named-checkzone test.example.com. /etc/bind/master-zones/test.example.com.loсal.zone
```

**named.conf.local** Это ещё один файл, который включается в общий конфиг сервера. В нём мы укажем локальные зоны:
```
zone "test.example.com." {
                type master;
                file "/etc/bind/master-zones/test.example.com.local.zone";
};
```

После того, как пропишем нужные данные, проверим конфиг и перезагрузим bind9 (флаг **-z** проверяет файлы зон):

```sh
sudo named-checkconf
sudo named-checkconf -z
sudo service bind9 restart
sudo service bind9 status
```

Основной конфигурационный файл сервера — **/etc/bind/named.conf** Он описывает общие настройки и обычно разбивается на несколько других для удобства. С работы с параметрами внутри этого файла начинается настройка DNS.

**named.conf.options** Этот файл содержит общие параметры сервера.

Настроим днс:
```sh
options {
        dnssec-validation auto;
        auth-nxdomain no;
        directory "/var/cache/bind";
        recursion no; # запрещаем рекурсивные запросы на сервер имён

        listen-on {
                     172.16.0.0/16; 
                     127.0.0.0/8;    };

        forwarders { 
172.16.0.1;
            8.8.8.8;  
        };
};
```

Чтобы **проверить**, что всё **внесено верно**, нужно воспользоваться одной из утилит демона named — **named-checkconf**.
`sudo named-checkconf`


## **Настройка представлений**

Настройка представлений позволяет гибко управлять разрешением имён из разных подсетей. В файле **/etc/bind/named.conf** укажем:

```sh
include "/etc/bind/named.conf.options";

acl "local" { 172.16.0.0/16; };
view "local" {
                include "/etc/bind/named.conf.local";
                match-clients { local; };
};
```

В этом же файле можно прописать директивы для указания тех узлов и адресов сетей, от которых нужно принимать или отклонять запросы.

Затем нужно заново **перезагрузить bind9**:
`sudo service bind9 restart`

После перезагрузки сервера с другого компьютера локальной сети можно запросить наличие у сервера **172.16.0.5 SOA-записи**: 
`dig @172.16.0.5 -t SOA test.example.com`

На этом этапе настройка основного DNS-сервера завершена. 